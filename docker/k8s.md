## 1. 容器健康检查

### 1.1 概览

对应 k8s 的 Liveness Porbe， 用于检测容器是否存活。如果容器的存活检查失败，集群会对该容器执行重启操作；若容器的存活检查成功则不执行任何操作。

对应 k8s 的 Readiness Probe，用于检测容器是否准备好开始处理用户请求。一些程序的启动时间可能很长，比如要加载磁盘数据或者要依赖外部的某个模块启动完成才能提供服务。这时候程序进程在，但是并不能对外提供服务。这种场景下该检查方式就非常有用。如果容器的就绪检查失败，集群会屏蔽请求访问该容器；若检查成功，则会开放对该容器的访问。

### 1.2 检查方式

#### TCP端口检查

通过容器的 IP 地址和端口号执行 TCP 检查，如果能够建立 TCP 连接，则表明容器健康

#### HTTP请求检查

通过容器的 IP 地址、端口号及路径调用 HTTP GET 方法，如果响应的状态码在 200 ~ 399 之间，则认为容器状态健康

#### 执行命令检查

在容器内部执行一个命令，如果该命令的返回码为 0，则表明容器健康

对于上面提到的 TCP 端口探测和 HTTP 请求探测，都可以通过执行命令检查的方式来替代：

- 对于 TCP 端口探测，我们可以写一个程序来对容器的端口进行 connect，如果 connect 成功，脚本返回 0，否则返回 -1。

- 对于 HTTP 请求探测，我们可以写一个脚本来对容器进行 wget

```bash
wget http://127.0.0.1:80/health-check
```

并检查 response 的返回码，如果返回码在 200~399 的范围，脚本返回 0，否则返回 -1。

```
注意：
- 必须把要执行的程序放在容器的镜像里面，否则会因找不到程序而执行失败。

- 如果执行的命令是一个 shell 脚本，不能直接指定脚本作为执行命令，需要加上脚本的解释器。

比如我们脚本是 
/data/scripts/health_check.sh
那么我们使用执行命令检查时，指定的程序应该是
sh /data/scripts/health_check.sh

究其原因是集群在执行容器里的程序时，不在终端环境下。
```